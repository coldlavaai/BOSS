# Detail Dynamics CRM - Complete Technical Architecture

**Project:** Custom CRM for Detail Dynamics (Austin's car detailing business)
**Client:** Oliver Tatler (Cold Lava) ‚Üí Austin (Detail Dynamics)
**Location:** Chichester, UK
**Build Start:** 2025-11-03
**Tech Stack:** Next.js 14 + Supabase + Vercel + Shadcn UI

---

## PROJECT OVERVIEW

Austin runs Detail Dynamics, a premium car detailing service in Chichester. Currently using HighLevel CRM but wants custom solution that:
- Costs less (HighLevel is expensive)
- Integrates better with Sophie (Retell AI voice agent) and VAPI chat widget
- Is simpler and tailored to his exact workflow

**Key Principle:** Build foundation RIGHT from Stage 1 - no rework needed later.

---

## 1. DATABASE SCHEMA

### 1.1 Core Tables

#### `customers`
```sql
CREATE TABLE customers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  phone TEXT NOT NULL,
  email TEXT NOT NULL,
  business_name TEXT,
  additional_contacts JSONB DEFAULT '[]'::jsonb,
  notes TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  CONSTRAINT customers_email_unique UNIQUE (email),
  CONSTRAINT customers_phone_unique UNIQUE (phone)
);

CREATE INDEX idx_customers_name ON customers USING gin(name gin_trgm_ops);
CREATE INDEX idx_customers_phone ON customers(phone);
CREATE INDEX idx_customers_email ON customers(email);

-- additional_contacts structure: [{"name": "John", "phone": "+44...", "email": "...", "relation": "Fleet Manager"}]
```

#### `cars`
```sql
CREATE TABLE cars (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
  make TEXT NOT NULL,
  model TEXT NOT NULL,
  year INTEGER NOT NULL,
  color TEXT,
  registration_plate TEXT,
  size_category TEXT NOT NULL CHECK (size_category IN ('Small', 'Medium', 'Large', 'XL')),
  size_override BOOLEAN DEFAULT false,
  notes TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_cars_customer ON cars(customer_id);
CREATE INDEX idx_cars_reg_plate ON cars(registration_plate);
CREATE INDEX idx_cars_make_model ON cars(make, model);
```

#### `service_categories`
```sql
CREATE TABLE service_categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL UNIQUE,
  description TEXT,
  display_order INTEGER NOT NULL DEFAULT 0,
  active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

#### `services`
```sql
CREATE TABLE services (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  category_id UUID NOT NULL REFERENCES service_categories(id) ON DELETE RESTRICT,
  name TEXT NOT NULL,
  description TEXT,
  duration_hours DECIMAL(4,2) NOT NULL,

  -- Pricing by car size (in pence)
  price_small INTEGER NOT NULL,
  price_medium INTEGER NOT NULL,
  price_large INTEGER NOT NULL,
  price_xl INTEGER NOT NULL,

  add_ons JSONB DEFAULT '[]'::jsonb,
  active BOOLEAN DEFAULT true,
  display_order INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  CONSTRAINT services_name_unique UNIQUE (name)
);

CREATE INDEX idx_services_category ON services(category_id);
CREATE INDEX idx_services_active ON services(active) WHERE active = true;
```

#### `jobs`
```sql
CREATE TABLE jobs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE RESTRICT,
  car_id UUID NOT NULL REFERENCES cars(id) ON DELETE RESTRICT,
  service_id UUID NOT NULL REFERENCES services(id) ON DELETE RESTRICT,

  booking_datetime TIMESTAMPTZ NOT NULL,
  status TEXT NOT NULL DEFAULT 'to_call_back' CHECK (
    status IN (
      'to_call_back',
      'new_booking',
      'job_in_progress',
      'job_completed',
      'review_request_sent',
      'review_received',
      'archived'
    )
  ),

  -- Pricing (in pence)
  base_price INTEGER NOT NULL,
  add_ons_total INTEGER DEFAULT 0,
  total_price INTEGER NOT NULL,
  deposit_paid BOOLEAN DEFAULT false,
  deposit_amount INTEGER,

  selected_add_ons JSONB DEFAULT '[]'::jsonb,

  source TEXT NOT NULL DEFAULT 'manual' CHECK (
    source IN ('manual', 'sophie', 'widget', 'phone', 'email', 'other')
  ),
  notes TEXT,
  tags TEXT[] DEFAULT '{}',

  -- Integration IDs
  google_calendar_event_id TEXT,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  archived_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ
);

CREATE INDEX idx_jobs_customer ON jobs(customer_id);
CREATE INDEX idx_jobs_car ON jobs(car_id);
CREATE INDEX idx_jobs_service ON jobs(service_id);
CREATE INDEX idx_jobs_status ON jobs(status);
CREATE INDEX idx_jobs_booking_datetime ON jobs(booking_datetime);
CREATE INDEX idx_jobs_source ON jobs(source);
CREATE INDEX idx_jobs_archived ON jobs(archived_at) WHERE archived_at IS NOT NULL;
CREATE INDEX idx_jobs_active ON jobs(status) WHERE status != 'archived';
```

#### `job_history`
```sql
CREATE TABLE job_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  job_id UUID NOT NULL REFERENCES jobs(id) ON DELETE CASCADE,
  changed_by TEXT NOT NULL DEFAULT 'system',
  change_type TEXT NOT NULL CHECK (
    change_type IN ('created', 'status_changed', 'updated', 'archived', 'note_added', 'email_sent', 'sms_sent')
  ),
  old_status TEXT,
  new_status TEXT,
  changes JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_job_history_job ON job_history(job_id);
CREATE INDEX idx_job_history_created ON job_history(created_at);
```

#### `vehicle_size_lookup`
```sql
CREATE TABLE vehicle_size_lookup (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  make TEXT NOT NULL,
  model TEXT NOT NULL,
  size_category TEXT NOT NULL CHECK (size_category IN ('Small', 'Medium', 'Large', 'XL')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  CONSTRAINT vehicle_size_lookup_unique UNIQUE (make, model)
);

CREATE INDEX idx_vehicle_lookup_make_model ON vehicle_size_lookup(make, model);
```

#### `webhook_logs`
```sql
CREATE TABLE webhook_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source TEXT NOT NULL CHECK (source IN ('sophie', 'widget')),
  payload JSONB NOT NULL,
  success BOOLEAN NOT NULL,
  job_id UUID REFERENCES jobs(id) ON DELETE SET NULL,
  error_message TEXT,
  ip_address INET,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_webhook_logs_source ON webhook_logs(source);
CREATE INDEX idx_webhook_logs_created ON webhook_logs(created_at);
CREATE INDEX idx_webhook_logs_success ON webhook_logs(success);
```

#### `email_threads` (NEW - Stage 7)
```sql
CREATE TABLE email_threads (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID REFERENCES customers(id) ON DELETE SET NULL,
  job_id UUID REFERENCES jobs(id) ON DELETE SET NULL,

  -- Microsoft Graph API references
  outlook_thread_id TEXT NOT NULL,
  outlook_message_id TEXT NOT NULL,

  subject TEXT NOT NULL,
  from_email TEXT NOT NULL,
  from_name TEXT,
  to_emails TEXT[] NOT NULL,
  cc_emails TEXT[] DEFAULT '{}',

  body_preview TEXT,
  has_attachments BOOLEAN DEFAULT false,

  is_read BOOLEAN DEFAULT false,
  is_sent BOOLEAN DEFAULT false,

  received_at TIMESTAMPTZ,
  sent_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  CONSTRAINT email_threads_outlook_message_unique UNIQUE (outlook_message_id)
);

CREATE INDEX idx_email_threads_customer ON email_threads(customer_id);
CREATE INDEX idx_email_threads_job ON email_threads(job_id);
CREATE INDEX idx_email_threads_outlook_thread ON email_threads(outlook_thread_id);
CREATE INDEX idx_email_threads_received ON email_threads(received_at);
CREATE INDEX idx_email_threads_from_email ON email_threads(from_email);
```

#### `email_templates` (NEW - Stage 7)
```sql
CREATE TABLE email_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL UNIQUE,
  subject TEXT NOT NULL,
  body_html TEXT NOT NULL,
  body_text TEXT NOT NULL,
  template_variables JSONB DEFAULT '[]'::jsonb,
  active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_email_templates_active ON email_templates(active) WHERE active = true;

-- template_variables: ["customer_name", "service_name", "booking_datetime", "deposit_amount"]
```

#### `settings`
```sql
CREATE TABLE settings (
  key TEXT PRIMARY KEY,
  value JSONB NOT NULL,
  description TEXT,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Settings storage for:
-- - webhook_api_keys
-- - google_calendar_config
-- - microsoft_oauth_tokens (Outlook)
-- - gmb_config
-- - auto_archive_days (default 30)
-- - business_hours
-- - notification_preferences
```

### 1.2 Database Functions & Triggers

#### Auto-update `updated_at` timestamp
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply to all tables with updated_at
CREATE TRIGGER update_customers_updated_at BEFORE UPDATE ON customers
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_cars_updated_at BEFORE UPDATE ON cars
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_services_updated_at BEFORE UPDATE ON services
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_jobs_updated_at BEFORE UPDATE ON jobs
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_email_threads_updated_at BEFORE UPDATE ON email_threads
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

#### Auto-archive old jobs
```sql
CREATE OR REPLACE FUNCTION archive_old_jobs()
RETURNS void AS $$
BEGIN
  UPDATE jobs
  SET
    status = 'archived',
    archived_at = now()
  WHERE
    status = 'review_received'
    AND completed_at < now() - INTERVAL '30 days'
    AND archived_at IS NULL;
END;
$$ LANGUAGE plpgsql;
```

#### Log job status changes
```sql
CREATE OR REPLACE FUNCTION log_job_status_change()
RETURNS TRIGGER AS $$
BEGIN
  IF (TG_OP = 'INSERT') THEN
    INSERT INTO job_history (job_id, change_type, new_status, changed_by)
    VALUES (NEW.id, 'created', NEW.status, 'system');
  ELSIF (OLD.status != NEW.status) THEN
    INSERT INTO job_history (job_id, change_type, old_status, new_status, changed_by)
    VALUES (NEW.id, 'status_changed', OLD.status, NEW.status, 'austin');
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER log_job_changes AFTER INSERT OR UPDATE ON jobs
  FOR EACH ROW EXECUTE FUNCTION log_job_status_change();
```

---

## 2. API DESIGN

### 2.1 Authentication Strategy

**Austin's Dashboard:**
- Supabase Auth (email/password)
- Single user account
- Session-based auth via Next.js middleware

**Webhook Endpoints:**
- API Key authentication (separate keys for Sophie and Widget)
- Keys stored in `settings` table, bcrypt-hashed
- Header: `Authorization: Bearer <api_key>`

**Microsoft OAuth (Outlook):**
- OAuth 2.0 flow for Outlook/Office 365
- Store access_token + refresh_token in `settings` table
- Auto-refresh tokens when expired

### 2.2 API Routes

#### Manual CRM Routes (Austin only)

```typescript
// Jobs
GET    /api/jobs
GET    /api/jobs/:id
POST   /api/jobs
PATCH  /api/jobs/:id
DELETE /api/jobs/:id

// Customers
GET    /api/customers
GET    /api/customers/:id
POST   /api/customers
PATCH  /api/customers/:id
DELETE /api/customers/:id

// Cars
GET    /api/cars
GET    /api/cars/:id
POST   /api/cars
PATCH  /api/cars/:id
DELETE /api/cars/:id

// Services
GET    /api/services
GET    /api/services/:id
POST   /api/services
PATCH  /api/services/:id
DELETE /api/services/:id

// Service Categories
GET    /api/service-categories
POST   /api/service-categories
PATCH  /api/service-categories/:id
DELETE /api/service-categories/:id

// Vehicle Size Lookup
GET    /api/vehicles/lookup?make=Ford&model=Fiesta
POST   /api/vehicles

// Dashboard Stats
GET    /api/dashboard/stats

// Settings
GET    /api/settings/:key
PATCH  /api/settings/:key
```

#### Webhook Routes (API Key auth)

```typescript
POST   /api/webhooks/sophie
POST   /api/webhooks/widget
```

#### Integration Routes

```typescript
// Google Calendar
GET    /api/integrations/google/auth
GET    /api/integrations/google/callback
POST   /api/integrations/google/sync

// Google My Business
GET    /api/integrations/gmb/reviews
POST   /api/integrations/gmb/auth

// Microsoft Outlook (NEW - Stage 7)
GET    /api/integrations/outlook/auth
GET    /api/integrations/outlook/callback
GET    /api/integrations/outlook/emails
POST   /api/integrations/outlook/send
PATCH  /api/integrations/outlook/emails/:id/read
POST   /api/integrations/outlook/sync
```

#### Email Routes (NEW - Stage 7)

```typescript
// Emails
GET    /api/emails                          // List all emails (filtered by job/customer)
GET    /api/emails/:id                      // Get single email with full body
POST   /api/emails/send                     // Send new email
PATCH  /api/emails/:id/read                 // Mark as read
POST   /api/emails/:id/link                 // Link email to job/customer
DELETE /api/emails/:id/link                 // Unlink email

// Email Templates
GET    /api/email-templates                 // List all templates
GET    /api/email-templates/:id             // Get template
POST   /api/email-templates                 // Create template
PATCH  /api/email-templates/:id             // Update template
DELETE /api/email-templates/:id             // Delete template
POST   /api/email-templates/:id/preview     // Preview with sample data
```

---

## 3. STAGED BUILD PLAN

### Stage 1: Foundation + Auth + Basic Kanban (3-5 days)
**Goal:** Austin can log in and manually manage jobs

**Deliverables:**
- ‚úÖ Next.js 14 project setup
- ‚úÖ Supabase project + database schema
- ‚úÖ Login page (Supabase Auth)
- ‚úÖ Dashboard layout with sidebar
- ‚úÖ Kanban board (7 columns, drag-drop)
- ‚úÖ Job CRUD (create, edit, delete)
- ‚úÖ Real-time updates (Supabase Realtime)

**Success Criteria:**
- Austin can log in
- Austin can create/edit/delete jobs
- Drag jobs between pipeline stages
- Changes reflect in real-time

---

### Stage 2: Customer & Car Management + Service Catalog (3-4 days)
**Goal:** Full data management capabilities

**Deliverables:**
- ‚úÖ Customers page (list, search, CRUD)
- ‚úÖ Customer detail page (cars, job history)
- ‚úÖ Cars management
- ‚úÖ Vehicle size lookup table (250+ vehicles)
- ‚úÖ Auto-detect car size
- ‚úÖ Services page (CRUD, pricing by size)
- ‚úÖ Service categories
- ‚úÖ Job creation wizard (multi-step)
- ‚úÖ Add-ons configuration

**Success Criteria:**
- Austin can manage customers/cars/services
- Car size auto-detected from make/model
- Job pricing auto-calculated
- Add-ons tracked per job

---

### Stage 3: Webhook Integration (2-3 days)
**Goal:** Sophie + VAPI can create jobs automatically

**Deliverables:**
- ‚úÖ Webhook endpoints (`/api/webhooks/sophie`, `/api/webhooks/widget`)
- ‚úÖ API key authentication
- ‚úÖ Payload validation
- ‚úÖ Customer/car lookup and creation logic
- ‚úÖ Auto-create jobs from webhooks
- ‚úÖ Webhook logging (`webhook_logs` table)
- ‚úÖ Rate limiting

**Success Criteria:**
- Sophie sends booking ‚Üí Job created
- Widget sends booking ‚Üí Job created
- No duplicate customers/cars
- All webhook attempts logged

---

### Stage 4: Dashboard Stats + Job History + Polish (2-3 days)
**Goal:** Full business visibility

**Deliverables:**
- ‚úÖ Dashboard stats (today's jobs, revenue, etc.)
- ‚úÖ Recent activity feed
- ‚úÖ Job history audit log
- ‚úÖ Auto-archive cron job (Supabase Edge Function)
- ‚úÖ CSV export
- ‚úÖ UI polish (loading states, errors, toasts)

**Success Criteria:**
- Dashboard shows accurate real-time stats
- Full job change history visible
- Jobs auto-archive after 30 days
- CSV export for accounting

---

### Stage 5: Google Calendar Integration (3-4 days)
**Goal:** Two-way sync between CRM and Google Calendar

**Deliverables:**
- ‚úÖ Google OAuth setup
- ‚úÖ Calendar connection in Settings
- ‚úÖ **Two-way sync:**
  - Jobs ‚Üí Calendar events (create/update/delete)
  - Calendar ‚Üí Jobs (detect external changes, sync back)
- ‚úÖ Conflict resolution
- ‚úÖ Manual sync button
- ‚úÖ Webhook listener for Calendar notifications

**Success Criteria:**
- New job creates Calendar event
- Editing job updates Calendar
- Deleting job removes Calendar event
- **External Calendar changes sync back to CRM**
- Customer reschedules in Calendar ‚Üí CRM job updated

**Technical Notes:**
- Google Calendar API v3
- Watch API for change notifications
- Idempotent sync (prevent duplicates)

---

### Stage 6: Google My Business Reviews + SMS (3-4 days)
**Goal:** Review tracking and notifications

**Deliverables:**
- ‚úÖ GMB API integration
- ‚úÖ Fetch reviews (daily cron)
- ‚úÖ Match reviews to jobs
- ‚úÖ Auto-move to "Review Received"
- ‚úÖ Reviews widget on Dashboard
- ‚úÖ SMS notifications (Twilio or n8n)
- ‚úÖ SMS templates (booking, reminder, review request)

**Success Criteria:**
- Reviews auto-sync daily
- Job status updates when review received
- SMS sent on status changes (optional)

---

### **Stage 7: Outlook Email Integration (4-5 days)** ‚ú® NEW

**Goal:** Send and receive emails inside CRM

**Deliverables:**

#### 7.1 Microsoft OAuth + Email Sync
- ‚úÖ Microsoft OAuth 2.0 setup (Graph API)
- ‚úÖ Connect Outlook account in Settings
- ‚úÖ Fetch inbox emails (sync last 30 days on connect)
- ‚úÖ Store email references in `email_threads` table
- ‚úÖ Auto-link emails to customers (match by email address)
- ‚úÖ Periodic sync (every 5 minutes via webhook or polling)

#### 7.2 Email Interface
- ‚úÖ Emails page (inbox view)
  - List of emails (sortable, filterable)
  - Search by subject, sender, date
  - Filter by customer, job, read/unread
- ‚úÖ Email detail view (modal or side panel)
  - Full email body (HTML rendering)
  - Attachments (view/download)
  - Thread history (conversation view)
  - Quick actions: Reply, Link to Job, Mark Read
- ‚úÖ Compose email (modal)
  - To/Cc/Bcc fields
  - Subject + body (rich text editor)
  - Attach files
  - Use template (dropdown)
  - Link to job/customer (optional)

#### 7.3 Email Templates
- ‚úÖ Template management page
- ‚úÖ Create/edit templates with variables
- ‚úÖ Variables: `{{customer_name}}`, `{{service_name}}`, `{{booking_datetime}}`, `{{deposit_amount}}`, etc.
- ‚úÖ Preview template with sample data
- ‚úÖ Default templates:
  - Booking confirmation
  - Reminder (1 day before)
  - Review request
  - Thank you

#### 7.4 Job Integration
- ‚úÖ Job detail modal: "Communications" tab
  - All emails linked to this job
  - Send email button (pre-fills customer email)
- ‚úÖ Customer detail page: Email history
- ‚úÖ Auto-log sent emails in `job_history`

#### 7.5 Automation (Optional - can defer)
- Auto-send email on status change (configurable in Settings)
- Email triggers:
  - Job created ‚Üí Booking confirmation
  - 1 day before booking ‚Üí Reminder
  - Job completed ‚Üí Thank you + review request

**Success Criteria:**
- Austin can view inbox inside CRM
- Austin can send emails from CRM (manually or via template)
- Emails auto-link to customers by email address
- Sent emails are tracked in job history
- Email threads show full conversation
- Templates work with variable substitution

**Technical Implementation:**
- **Microsoft Graph API** (`/me/messages`, `/me/sendMail`)
- **OAuth 2.0** (delegated permissions: `Mail.ReadWrite`, `Mail.Send`)
- **Delta sync** (use Graph API delta queries for efficient syncing)
- **Rich text editor** (Tiptap or Lexical)
- **Email storage:** Store references only (don't duplicate emails in DB)
- **Attachments:** Stream from Graph API (don't store locally unless needed)

**UI Components:**
- Email list (table or card view)
- Email detail panel (like Gmail)
- Compose modal (rich text editor)
- Template picker dropdown
- Customer/job linking interface

**Challenges:**
- **Email matching:** Fuzzy matching if customer changes email or uses different email
- **Thread tracking:** Graph API thread IDs
- **Attachments:** Large files (stream vs. store)
- **Rate limits:** Graph API has throttling (defer to batching)

**Optional Enhancements (Post-Stage 7):**
- Email scheduling (send later)
- Email tracking (read receipts via tracking pixel)
- Bulk email (send to multiple customers)
- Email signatures (configurable in Settings)

---

## 4. PIPELINE STAGES (Kanban Columns)

1. **To Call Back** - Sophie escalations, quote requests
2. **New Booking** - Confirmed bookings (deposit paid icon shown on card)
3. **Job In Progress** - Austin is working on the job
4. **Job Completed** - Service finished
5. **Review Request Sent** - Waiting for customer review
6. **Review Received** - Customer left GMB review
7. **Archive** - Jobs older than 30 days (auto-archived)

---

## 5. JOB CARD DESIGN

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üöó John Smith                       ‚îÇ
‚îÇ Ford Fiesta (Blue) ‚Ä¢ AB12 CDE       ‚îÇ
‚îÇ Full Valet ‚Ä¢ ¬£75                    ‚îÇ
‚îÇ üìÖ Nov 5, 10:00 AM                  ‚îÇ
‚îÇ üí∞ Deposit Paid ‚úì                   ‚îÇ
‚îÇ üè∑Ô∏è Sophie                           ‚îÇ
‚îÇ üìß 3 emails                          ‚îÇ ‚Üê NEW (Stage 7)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Click card ‚Üí Job detail modal with tabs:**
- Details (customer, car, service, pricing)
- Notes
- Activity (status changes, audit log)
- **Communications (emails + SMS)** ‚Üê NEW (Stage 7)

---

## 6. TECHNOLOGY STACK

- **Frontend:** Next.js 14.2+ (App Router), TypeScript
- **UI:** Shadcn UI + Tailwind CSS
- **Database:** Supabase (PostgreSQL)
- **Auth:** Supabase Auth
- **Hosting:** Vercel
- **Drag-Drop:** @dnd-kit
- **Real-time:** Supabase Realtime
- **Rich Text Editor:** Tiptap (for email compose)
- **Integrations:**
  - Google Calendar API
  - Google My Business API
  - Microsoft Graph API (Outlook)
  - Twilio (SMS) or n8n

---

## 7. ENVIRONMENT VARIABLES

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbG...
SUPABASE_SERVICE_ROLE_KEY=eyJhbG... # For webhooks

# App
NEXT_PUBLIC_APP_URL=https://detaildynamics-crm.vercel.app

# Google Calendar (Stage 5)
GOOGLE_CLIENT_ID=xxxxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-xxxxx
GOOGLE_REDIRECT_URI=https://detaildynamics-crm.vercel.app/api/integrations/google/callback

# Google My Business (Stage 6)
GMB_CLIENT_ID=xxxxx.apps.googleusercontent.com
GMB_CLIENT_SECRET=GOCSPX-xxxxx

# Microsoft Outlook (Stage 7) - NEW
MICROSOFT_CLIENT_ID=xxxxx
MICROSOFT_CLIENT_SECRET=xxxxx
MICROSOFT_TENANT_ID=common
MICROSOFT_REDIRECT_URI=https://detaildynamics-crm.vercel.app/api/integrations/outlook/callback

# SMS (Stage 6)
TWILIO_ACCOUNT_SID=ACxxxxx
TWILIO_AUTH_TOKEN=xxxxx
TWILIO_PHONE_NUMBER=+447700900000
# OR
N8N_WEBHOOK_URL=https://otdm22.app.n8n.cloud/webhook/send-sms
N8N_API_KEY=n8n_api_xxxxx
```

---

## 8. NEXT STEPS

**Current Status:** Architecture complete, ready to build

**Immediate Action:**
1. ‚úÖ Save this document to `~/Documents/detail-dynamics-crm/.claude-context.md`
2. Confirm priorities with Oliver:
   - Should Email (Stage 7) come before Calendar/GMB?
   - What's the minimum viable product (MVP) stage?
3. Begin Stage 1 build (Foundation)

**Build Timeline (estimated):**
- Stage 1: 3-5 days
- Stage 2: 3-4 days
- Stage 3: 2-3 days
- Stage 4: 2-3 days
- Stage 5: 3-4 days (Google Calendar - two-way sync)
- Stage 6: 3-4 days (GMB + SMS)
- Stage 7: 4-5 days (Outlook Email)

**Total:** 20-28 days for complete CRM with all features

**MVP Option (Stages 1-4 only):** 10-15 days for core CRM without integrations

---

## 9. WEBHOOK PAYLOAD SPECIFICATIONS

### Sophie (Retell AI)
```json
{
  "source": "sophie",
  "customer": {
    "name": "John Smith",
    "phone": "+447700900123",
    "email": "john@example.com"
  },
  "car": {
    "make": "Ford",
    "model": "Fiesta",
    "year": 2020,
    "color": "Blue",
    "registration": "AB12 CDE"
  },
  "service": {
    "name": "Full Valet"
  },
  "booking": {
    "datetime": "2025-11-05T10:00:00Z",
    "notes": "Customer requested mobile service"
  },
  "deposit": {
    "paid": true,
    "amount": 2500
  }
}
```

### VAPI Widget
```json
{
  "source": "widget",
  "customer": {
    "name": "Jane Doe",
    "phone": "+447700900456",
    "email": "jane@example.com"
  },
  "car": {
    "make": "BMW",
    "model": "3 Series",
    "year": 2019
  },
  "service": {
    "name": "Paint Correction",
    "add_ons": ["Ceramic Coating"]
  },
  "booking": {
    "datetime": "2025-11-06T09:00:00Z"
  }
}
```

---

**END OF ARCHITECTURE**

*Last updated: 2025-11-03*
*Build status: Ready to start Stage 1*
